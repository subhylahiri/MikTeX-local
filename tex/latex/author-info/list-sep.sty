% -*- TeX -*- -*- STY -*- -*- LaTeX3 -*-
%--------------------------------------------------------------------------------
%     Processing lists, adding punctuation, ...
%
% You'll either need to \DeclareInstance or \UseTemplate, followed by a
% \EditInstance { length = ... }
% Or, inside template code where the instance comes from a kay:
%   \listsep_edit_length:Nn \<template cs> {<new-length>}
%
% Before loop:  \int_zero:N <int-var>
%               \UseInstance ... {<tl-var>} {<int-var>}
% This sets up <int-var> as a countdown timer, and appends any prefix to <tl-var>
% In loop:      \UseInstance ... {<tl-var>} {<int-var>}
% This decrements the counter and appends punctuation to <tl-var>
%
\RequirePackage{expl3}
\ProvidesExplPackage {list-sep} {2019/09/22} {v0.1} {automatic list separators}
\RequirePackage{xtemplate}
\RequirePackage{xparse}
%================================================================================
% Interface
%================================================================================
\DeclareObjectType { punctuator } {2} % return tl-var, list members seq-var
%================================================================================
\DeclareTemplateInterface { punctuator } { in-sentence } {2}
  {
    prefix          : tokenlist = {} ,
    pair            : tokenlist = {} ,
    antepenultimate : tokenlist = {} ,
    penultimate     : tokenlist = {} ,
    ultimate        : tokenlist = {} ,
    append          : boolean = true ,
    global          : boolean = false ,
  }
\DeclareTemplateInterface { punctuator } { inline-list } {2}
  {
    prefix      : tokenlist = {} ,
    separator   : tokenlist = {} ,
    final       : tokenlist = {} ,
    append      : boolean = true ,
    global      : boolean = false ,
  }
\DeclareTemplateInterface { punctuator } { map-clist } {2}
  {
    seq-version : instance { punctuator } ,
  }
%================================================================================
\tl_new:N \l__listsep_scratch_tl
\tl_new:N \l__listsep_insent_prf_tl
\tl_new:N \l__listsep_insent_pr_tl
\tl_new:N \l__listsep_insent_ap_tl
\tl_new:N \l__listsep_insent_pu_tl
\tl_new:N \l__listsep_insent_ul_tl
\bool_new:N \l__listsep_insent_app_bool
\bool_new:N \l__listsep_insent_glb_bool

\DeclareTemplateCode  { punctuator } { in-sentence } {2}
  {
    prefix          = \l__listsep_insent_prf_tl ,
    pair            = \l__listsep_insent_pr_tl ,
    antepenultimate = \l__listsep_insent_ap_tl ,
    penultimate     = \l__listsep_insent_pu_tl ,
    ultimate        = \l__listsep_insent_ul_tl ,
    append          = \l__listsep_insent_app_bool ,
    global          = \l__listsep_insent_glb_bool ,
  }
{
  \group_begin:
    \AssignTemplateKeys
    \int_set:Nn \l_tmpa_int { \seq_count:N #2 }
    \tl_clear:N \l__listsep_scratch_tl
    \int_compare:nNnT { \l_tmpa_int } = {2}
      { \tl_set_eq:NN \l__listsep_insent_pu_tl \l__listsep_insent_pr_tl }

    \int_compare:nNnT { \l_tmpa_int } > {0}
      {
        \tl_put_right:NV \l__listsep_scratch_tl \l__listsep_insent_prf_tl
        \seq_map_inline:Nn #2
          {
            \tl_put_right:Nn \l__listsep_scratch_tl {##1}
            \int_case:nnF { \l_tmpa_int }
              {
                {1} { \tl_gput_right:NV \l__listsep_scratch_tl \l__listsep_insent_ul_tl }
                {2} { \tl_gput_right:NV \l__listsep_scratch_tl \l__listsep_insent_pu_tl }
              }
              { \tl_gput_right:NV \l__listsep_scratch_tl \l__listsep_insent_ap_tl }
            \int_decr:N \l_tmpa_int
          }
      }

    \bool_if:NTF \l__listsep_insent_glb_bool
      {
        \bool_if:NTF \l__listsep_insent_app_bool
          { \tl_gput_right:NV #1 \l__listsep_scratch_tl }
          { \tl_gset_eq:NN #1 \l__listsep_scratch_tl }
        \bool_gset_false:N \g_tmpb_bool
      }
      {
        \tl_gset_eq:NN \g_tmpa_tl \l__listsep_scratch_tl
        \bool_gset_eq:NN \g_tmpa_bool \l__listsep_insent_app_bool
        \bool_gset_true:N \g_tmpb_bool
      }
  \group_end:
  \bool_if:NT \g_tmpb_bool
    {
      \bool_if:NTF \g_tmpa_bool
        { \tl_put_right:NV #1 \g_tmpa_tl }
        { \tl_set_eq:NN #1 \g_tmpa_tl }
      \tl_gclear:N \g_tmpa_tl
    }
}
%--------------------------------------------------------------------------------
\tl_new:N \l__listsep_agram_prf_tl
\tl_new:N \l__listsep_agram_sep_tl
\tl_new:N \l__listsep_agram_end_tl
\bool_new:N \l__listsep_agram_app_bool
\bool_new:N \l__listsep_agram_glb_bool

\DeclareTemplateCode  { punctuator } { inline-list } {2}
  {
    prefix      = \l__listsep_agram_prf_tl ,
    separator   = \l__listsep_agram_sep_tl ,
    final       = \l__listsep_agram_end_tl ,
    append      = \l__listsep_agram_app_bool ,
    global      = \l__listsep_agram_glb_bool ,
  }
{
  \group_begin:
    \AssignTemplateKeys
    \bool_gset:Nn \g_tmpa_bool \l__listsep_agram_app_bool
    \int_set:Nn \l_tmpa_int { \seq_count:N #2 }
    \tl_clear:N \l__listsep_scratch_tl

    \int_compare:nNnT { \l_tmpa_int } > {0}
      {
        \tl_put_right:NV \l__listsep_scratch_tl \l__listsep_agram_prf_tl
        \seq_map_inline:Nn #2
          {
            \tl_put_right:Nn \l__listsep_scratch_tl {##1}
            \int_compare:nNnTF { \l_tmpa_int } = {1}
              { \tl_put_right:NV \l__listsep_scratch_tl \l__listsep_agram_end_tl }
              { \tl_put_right:NV \l__listsep_scratch_tl \l__listsep_agram_sep_tl }
            \int_decr:N \l_tmpa_int
          }
      }

    \bool_if:NTF \l__listsep_agram_glb_bool
      {
        \bool_if:NTF \l__listsep_agram_app_bool
          { \tl_gput_right:NV #1 \l__listsep_scratch_tl }
          { \tl_gset_eq:NN #1 \l__listsep_scratch_tl }
        \bool_gset_false:N \g_tmpb_bool
      }
      {
        \tl_gset_eq:NN \g_tmpa_tl \l__listsep_scratch_tl
        \bool_gset_eq:NN \g_tmpa_bool \l__listsep_agram_app_bool
        \bool_gset_true:N \g_tmpb_bool
      }
  \group_end:
  \bool_if:NT \g_tmpb_bool
    {
      \bool_if:NTF \g_tmpa_bool
        { \tl_put_right:NV #1 \g_tmpa_tl }
        { \tl_set_eq:NN #1 \g_tmpa_tl }
      \tl_gclear:N \g_tmpa_tl
    }
}

%--------------------------------------------------------------------------------
\seq_new:N \l__listsep_scratch_seq

\DeclareTemplateCode  { punctuator } { map-clist } {2}
  {
    seq-version = \__listsep_clist_wrapper:nn ,
  }
{
  \seq_set_from_clist:Nn \l__listsep_scratch_seq {#2}
  \__listsep_clist_wrapper:nn {#1} { \l__listsep_scratch_seq }
}
%================================================================================
\DeclareRestrictedTemplate { punctuator } { in-sentence } { mid-sentence }
  {
    ultimate    = {} ,
  }
\DeclareRestrictedTemplate { punctuator } { inline-list } { mid-list }
  {
    final   = \KeyValue { separator } ,
  }
\DeclareRestrictedTemplate { punctuator } { inline-list } { endless-list }
  {
    final   = {} ,
  }
%--------------------------------------------------------------------------------
\DeclareInstance { punctuator } { oxford-comma } { in-sentence }
  {
    pair            = {~and~} ,
    antepenultimate = {,~} ,
    penultimate     = {,~and~} ,
    ultimate        = {.} ,
  }
\DeclareInstance { punctuator } { cambridge-comma } { in-sentence }
  {
    pair            = {~and~} ,
    antepenultimate = {,~} ,
    penultimate     = {~and~} ,
    ultimate        = {.} ,
  }
%    ...............................................................
\DeclareInstance { punctuator } { oxford-comma-mid } { mid-sentence }
  {
    pair            = {~and~} ,
    antepenultimate = {,~} ,
    penultimate     = {,~and~} ,
  }
\DeclareInstance { punctuator } { cambridge-comma-mid } { mid-sentence }
  {
    pair            = {~and~} ,
    antepenultimate = {,~} ,
    penultimate     = {~and~} ,
  }
%    ...............................................................
\DeclareInstance { punctuator } { all-comma } { inline-list }
  {
    separator = {,~} ,
    final     = {.} ,
  }
\DeclareInstance { punctuator } { semicolon } { inline-list }
  {
    separator = {;~} ,
    final     = {.} ,
  }
%    ...............................................................
\DeclareInstance { punctuator } { all-comma-mid } { mid-list }
  {
    separator = {,~} ,
  }
\DeclareInstance { punctuator } { semicolon-mid } { mid-list }
  {
    separator = {;~} ,
  }
%    ...............................................................
\DeclareInstance { punctuator } { all-comma-noend } { endless-list }
  {
    separator = {,~} ,
  }
\DeclareInstance { punctuator } { semicolon-noend } { endless-list }
  {
    separator = {;~} ,
  }
\DeclareInstance { punctuator } { none } { endless-list }
  {
    separator = {} ,
  }
%================================================================================

% Get name of instance from template variable (function)
% #1: function created by template key of type instance{punctuator}
%
\cs_new:Nn \__listsep_instance_name:N
  { \tl_item:Nn #1 {-1} }

% Change a key parameter of instance from template variable (function)
% #1: function created by template key of type instance{punctuator}
% #2: parameter name
% #3: new value for parameter
% Expected use: modify 'global' and/or 'append'
%
\cs_new_protected:Nn \listsep_edit_key:Nnn
{
  \exp_args:Nnx \EditInstance { punctuator } { \__listsep_instance_name:N #1 }
    { #2 = #3 }
}
\cs_generate_variant:Nn \listsep_edit_key:Nnn { Nnx }

%================================================================================
\endinput
