% -*- TeX -*- -*- STY -*- -*- LaTeX3 -*-
%
% Processing inputs -> our form
%
%================================================================================
\ProvidesExplFile {sl-author-info-au.def} {2019/09/18} {v1.0}
    {print author lists for sl-author-info.sty (SL)}
%================================================================================
%\RequirePackage{expl3}
%\RequirePackage{interface3}
%\RequirePackage{xparse}
%\RequirePackage{xtemplate}
%\RequirePackage{titling}
%\RequirePackage{process-name}
%================================================================================
% hooks for format, content, format
\tl_new:N \g__slauth_auth_pre_tl
\tl_new:N \g__slauth_auth_hook_tl
\tl_new:N \g__slauth_auth_post_tl
%--------------------------------------------------------------------------------
% Placing hooks
\preauthor{\g__slauth_auth_pre_tl}
\renewcommand{\@author}{\g__slauth_auth_hook_tl}
\postauthor{\g__slauth_auth_post_tl}
%================================================================================
% Author list variables (auls)
\seq_new:N \l__slauth_auls_seq
\tl_new:N \l__slauth_auls_sep_pr_tl
\tl_new:N \l__slauth_auls_sep_ap_tl
\tl_new:N \l__slauth_auls_sep_pu_tl
\tl_new:N \l__slauth_auls_sep_ul_tl
\tl_new:N \l__slauth_auls_sorter_tl
\tl_new:N \l__slauth_auls_individual_tl
\tl_new:N \l__slauth_auls_style_pre_tl
\tl_new:N \l__slauth_auls_style_post_tl
\skip_new:N \l__slauth_auls_pr_skip
\skip_new:N \l__slauth_auls_po_skip

% Output the list of authors
% The list was compiled elsewhere, it is a sequence of property lists.
% Each property list has (some of) the keys:
%   token-lists: given, family, refix, suffix
%   sequences: affil, email, thanks
%
\DeclareTemplateCode { people } { author-list } {1}
  {
    style-pre           = \l__slauth_auls_style_pre_tl ,
    style-post          = \l__slauth_auls_style_post_tl ,
    sep-pair            = \l__slauth_auls_sep_pr_tl ,
    sep-antepenultimate = \l__slauth_auls_sep_ap_tl ,
    sep-penultimate     = \l__slauth_auls_sep_pu_tl ,
    sep-ultimate        = \l__slauth_auls_sep_ul_tl ,
    before-skip         = \l__slauth_auls_pr_skip ,
    after-skip          = \l__slauth_auls_po_skip ,
    sorter              = \__slauth_auls_sorter:nn ,
    individual          = \__slauth_auls_individual:nn ,
  }
{
  \group_begin:
    \AssignTemplateKeys
    \seq_set_eq:NN \l__slauth_auls_seq #1
    \int_set:Nn \l_tmpa_int { \seq_count:N \l__slauth_auls_seq }
    \procname_sep_seq:NVVVVV \l_tmpa_seq \l_tmpa_int
      \l__slauth_auls_sep_pr_tl \l__slauth_auls_sep_ap_tl
      \l__slauth_auls_sep_pu_tl \l__slauth_auls_sep_ul_tl

    \procname_sort_seq:NN \l__slauth_auls_seq \__slauth_auls_sorter:nn

    % using prop-list as token-list variable?
    \seq_map_variable:NNn \l__slauth_auls_seq \l_tmpa_prop
      {
        \tl_set:Nx \l_tmpa_tl
          { \procname_sep_choose:NV \l_tmpa_seq \l_tmpa_int }
        \__slauth_auls_individual:nn { \l_tmpa_prop } { \l_tmpa_tl }
        \int_decr:N \l_tmpa_int
      }

    \__slauth_outer_hooks:VVVVn \l__slauth_auls_pr_skip \l__slauth_auls_po_skip
      \l__slauth_auls_style_pre_tl \l__slauth_auls_style_post_tl { auth }
  \group_end:
}
%--------------------------------------------------------------------------------

% Author variables (au)
\tl_new:N \l__slauth_au_formatter_tl
\tl_new:N \l__slauth_au_tag_tl
\cs_new:Nn \__slauth_au_insert_tags:n {#1}

% #1: property list for author, prop-var
% #2: separator (has parameter code for tags) tl-var
%
\DeclareTemplateCode { person } { author } {2}
  {
    tagger      = \__slauth_au_tag:nn ,
    formatter   = \__slauth_au_formatter:nn ,
  }
{
  \group_begin:
    \AssignTemplateKeys
    \__slauth_au_formatter:nn { \g__slauth_auth_hook_tl } {#1}
    \tl_set_eq:NN \l_tmpb_tl #2
    \tl_clear:N \l_tmpa_tl
    \__slauth_au_tag:nn { \l_tmpa_tl } {#1}
    \exp_args:NNnV \tl_replace_all:Nnn \l_tmpb_tl {&} \l_tmpa_tl
    \tl_gput_right:NV \g__slauth_auth_hook_tl \l_tmpb_tl
  \group_end:
}

%================================================================================
% Insert all tags of a given type
% #1: tl-var to append to
% #2: seq-var of tag labels
% #3: function to apply to labels
%
\cs_new_protected:Nn \__slauth_autag_type:NNN
{
  \int_set:Nn \l_tmpb_int { \seq_count:N #2 }
  \seq_map_inline:Nn #2
    {
      \slauth_expand_func_arg:NNn #1 #3 {##1}
      \int_compare:nNnT { \l_tmpb_int } > { 1 }
        { \tl_put_right:NV #1 \l__slauth_autag_sep_tl }
      \int_decr:N \l_tmpb_int
    }
}
%--------------------------------------------------------------------------------
\tl_new:N \l__slauth_autag_sep_tl
\tl_new:N \l__slauth_autag_pre_tl
\tl_new:N \l__slauth_autag_post_tl

\DeclareTemplateCode { person-info } { author-tags } {2}
  {
    tags        = \__slauth_autag_outer:n ,
    affil-tag   = \__slauth_autag_affil:n ,
    email-tag   = \__slauth_autag_email:n ,
    thanks-tag  = \__slauth_autag_thanks:n ,
    tag-sep     = \l__slauth_autag_sep_tl ,
    pre-tags    = \l__slauth_autag_pre_tl ,
    post-tags   = \l__slauth_autag_post_tl ,
  }
{
  \group_begin:
    \AssignTemplateKeys
    \tl_clear:N \l_tmpa_tl
    \tl_gclear:N \g_tmpa_tl
    \tl_set_eq:NN \l_tmpb_tl \l__slauth_autag_pre_tl

    \prop_get:NnNT #2 { affil } \l_tmpa_seq
      {
        \tl_put_right:NV \l_tmpa_tl \l_tmpb_tl
        \__slauth_autag_type:NNN \l_tmpa_tl \l_tmpa_seq \__slauth_autag_affil:n
        \tl_set_eq:NN \l_tmpb_tl \l__slauth_autag_sep_tl
      }

    \prop_get:NnNT #2 { email } \l_tmpa_seq
      {
        \tl_put_right:NV \l_tmpa_tl \l_tmpb_tl
        \__slauth_autag_type:NNN \l_tmpa_tl \l_tmpa_seq \__slauth_autag_email:n
        \tl_set_eq:NN \l_tmpb_tl \l__slauth_autag_sep_tl
      }

    \prop_get:NnNT #2 { thanks } \l_tmpa_seq
      {
        \tl_put_right:NV \l_tmpa_tl \l_tmpb_tl
        \__slauth_autag_type:NNN \l_tmpa_tl \l_tmpa_seq \__slauth_autag_thanks:n
      }

    \tl_if_blank:VF \l_tmpa_tl
      {
        \tl_put_right:NV \l_tmpa_tl \l__slauth_autag_post_tl
        \slauth_gexpand_func_arg:NNV \g_tmpa_tl \__slauth_autag_outer:n \l_tmpa_tl
      }
  \group_end:
  % set the output variable then erase global changes
  \tl_put_right:NV #1 \g_tmpa_tl
  \tl_gclear:N \g_tmpa_tl
}

%================================================================================
\endinput
