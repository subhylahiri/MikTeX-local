% -*- TeX -*- -*- STY -*- -*- LaTeX3 -*-
%
% Combining the parts
%
%================================================================================
\RequirePackage{expl3}
\ProvidesExplPackage {sl-author-info-main} {2019/09/18} {v1.0}
    {titling macros for affiliations etc. (SL)}
%================================================================================
%\RequirePackage{interface3}
\RequirePackage{xparse}
\RequirePackage{xtemplate}
\RequirePackage{titling}
\RequirePackage{process-name}
%================================================================================
% Error messages
%================================================================================
%\cs_if_exist:NTF \g__slauth_auth_hook_tl - but its empty for now
\@ifpackageloaded{sl-author-info}{}{
\msg_new:nnnn { slauth } { loaded-early }
  { This~package~should~be~loaded~via~'sl-author-info' }
  {
    This~package~should~not~be~loaded~directly.~Load~'sl-author-info'~instead.
    \\ 'sl-author-info'~will~load~this~sub-package~for~you.
  }
\msg_error:nn { slauth } { loaded-early }
}
%================================================================================
% Tools.
%================================================================================
% Label at beginning of line: zero width superscript
% #1: Label
%
\cs_new:Nn \slauth_left_super:n
  { {}\textsuperscript{\llap{#1}} }
%--------------------------------------------------------------------------------
% Expand function and argument once
% #1: tl-var for result (prev value wiped)
% #2: function
% #3: tl-var holding the argument
%
\cs_new_protected:Nn \slauth_gexpand_func_arg:NNn
{
  \group_begin:
    \tl_set:Nn \l_tmpa_tl { #2 {#3} }
    \tl_set:Nx \l_tmpa_tl { \exp_args:NV \exp_not:o \l_tmpa_tl }
    \tl_gput_right:NV #1 \l_tmpa_tl
  \group_end:
}
\cs_new_protected:Nn \slauth_expand_func_arg:NNn
{
  \tl_gclear:N \g_tmpa_tl
  \slauth_gexpand_func_arg:NNn \g_tmpa_tl #2 {#3}
  \tl_put_right:NV #1 \g_tmpa_tl
  \tl_gclear:N \g_tmpa_tl
}
\cs_generate_variant:Nn \slauth_gexpand_func_arg:NNn {      Ncn, cNn, ccn }
\cs_generate_variant:Nn \slauth_gexpand_func_arg:NNn { NNV, NcV, cNV, ccV }
\cs_generate_variant:Nn \slauth_expand_func_arg:NNn {      Ncn, cNn, ccn }
\cs_generate_variant:Nn \slauth_expand_func_arg:NNn { NNV, NcV, cNV, ccV }
%--------------------------------------------------------------------------------

% Write pre/post hooks
% #1: pre-skip
% #2: post-skip
% #3: pre-text
% #4: post-text
% #5: hook name
%
\cs_new_protected:Nn \__slauth_outer_hooks:nnnnn
{
  \group_begin:
    \tl_set:Nn \l_tmpa_tl {g__slauth_#5_hook_tl}
    % Don't add spaces if there's nothing in the hook!
    \tl_if_empty:cF { \l_tmpa_tl }
      {
        % cname of pre contact hook
        \tl_set:Nn \l_tmpa_tl {g__slauth_#5_pre_tl}
        \tl_gput_right:cn { \l_tmpa_tl } { \skip_vertical:n {#1} #3 }

        % cname of post contact hook
        \tl_set:Nn \l_tmpa_tl {g__slauth_#5_post_tl}
        \tl_gput_right:cn { \l_tmpa_tl } { #4 \skip_vertical:n {#2} }
      }
  \group_end:
}
\cs_generate_variant:Nn \__slauth_outer_hooks:nnnnn {        VVnVn, VVVnn, VVVVn, }
\cs_generate_variant:Nn \__slauth_outer_hooks:nnnnn { VVnnV, VVnVV, VVVnV, VVVVV, }
%--------------------------------------------------------------------------------

% Place the foot hook in the footer, if needed
%
\cs_new_protected:Nn \__slauth_create_foot:
{
  \tl_if_empty:NF \g__slauth_foot_hook_tl
    {
      \global\setlength{\thanksmarkwidth}{0em}
      \global\setlength{\thanksmargin}{-1em}
      \gdef\tamark{}
      \tl_gput_right:Nn \@thanks
        { \footnotetext[1]{\g__slauth_foot_hook_tl} }
    }
}
%================================================================================
% Template implementation

\DeclareTemplateCode { people-block } { author-block } {4}
  {
    authors         = \__slauth_block_au:n ,
    affiliations    = \__slauth_block_af:n ,
    emails          = \__slauth_block_em:n ,
    thanks          = \__slauth_block_th:n ,
  }
{
  \group_begin:
    \AssignTemplateKeys
    \__slauth_block_au:n {#1}
    \__slauth_block_af:n {#2}
    \__slauth_block_em:n {#3}
    \__slauth_block_th:n {#4}
    % create footer, if needed
    \__slauth_create_foot:
    % Delete unneeded data
    \seq_gclear:N #1
    \prop_gclear:N #2
    \prop_gclear:N #3
    \prop_gclear:N #4
  \group_end:
}
%================================================================================
\endinput
