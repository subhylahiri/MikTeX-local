% -*- TeX -*- -*- STY -*- -*- LaTeX-Expl3 -*-
%%  This uses the package ``delim'' to define custom delimiters
%%
%% Requires packages: expl3, mathtools, MnSymbol
%%
%% All delimiters use \left,\middle,\right by default.
%% They can be changed on a case-by-case basis by providing
%% the size command as an optional argument.
%% Resizing can be turned off by using the starred version.
%% e.g.
%%    \begin{equation}
%%      \brk[\bigg]{\sum_a^b \set*{x^2}{x \in R}}.
%%    \end{equation}
%%
%% Delimiters defined:
%%    \prn{}
%%    \brc{}
%%    \brk{}
%%    \abs{}
%%    \nrm{}
%%    \av{}
%%    \avc{}{}
%%    \ceil{}
%%    \floor{}
%%    \set{}{}
%%    \cond{}{}
%%    \condb{}{}
%%    \bra{}
%%    \ket{}
%%    \braket{}{}
%%    \brackets{}{}{}
%%    \prnfrac{}{}
%%    \brcfrac{}{}
%%    \brkfrac{}{}
%%    \absfrac{}{}
%%    \nrmrac{}{}
%%    \ceilrac{}{}
%%    \floorrac{}{}
%%
%% History: 2018/03/17 v1.0      copied & updated defns from sl_definitions.tex
%%          2021/08/07 v2.0      use expl3
%-------------------------------------------------------------------------------
\RequirePackage{expl3}
\ProvidesExplPackage {sl-delims} {2021-08-07} {2.0} {custom delimiters}
\ExplSyntaxOn
%================================================================================
\RequirePackage{xparse}
\RequirePackage{mathtools}
\RequirePackage{MnSymbol}
%--------------------------------------------------------------------------------
\tl_new:N \l__sldelims_csname_tl
\tl_new:N \l__sldelims_argspec_tl
\tl_new:N \l__sldelims_arguse_tl
\tl_new:N \l__sldelims_code_tl
\tl_new:N \g_sldelims_placeholder_tl
\tl_cs_gset:Nn \g_sldelims_placeholder_tl { \:\cdot\: }
%--------------------------------------------------------------------------------
% Replace omitted argument with placeholder.
% #1: optional argument
\cs_new:Nn \__sldelims_opt:n
  {
    \tl_if_blank:nTF {#1}
      { \g_sldelims_placeholder_tl }
      { #1 }
  }
%--------------------------------------------------------------------------------
% Put 2nd token list in braces and append to 1st
% #1: tl-var to append to
% #2: token list to be put in braces and appended
\cs_new_protected:Nn \__sldelims_tl_put_right_braced:Nn
  { \tl_put_right:Nn #1 { {#2} } }
\cs_generate_variant:Nn \__sldelims_tl_put_right_braced:Nn { NV }
%--------------------------------------------------------------------------------
% Choose which version of delimiter command to use, swapping starred/unstarred
% #1: Private function that implements deliiters
% #2: Boolean - Was there a star on the public function?
% #3: Optional argument to the public function
% #4: All other arguments to the public function, in braces, inside *one* argument
\cs_new:Nn \__sldelims_choose:Nnnn
  {
    \IfNoValueTF {#3}
      {
        \IfBooleanTF {#2}
          { #1 #4 }
          { #1* #4 }
      }
      { #1 [#3] #4 }
  }
\cs_generate_variant:Nn \__sldelims_choose:Nnnn { c }
%================================================================================
% Define delimiters with one argument, simple insertion
% #1: Command to define
% #2: Left delimiter
% #3: Right delimiter
\cs_new_protected:Nn \__sldelims_new:Nnn
  {
    \tl_set:Nx \l__sldelims_csname_tl { \cs_to_str:N #1 }
    \tl_put_left:Nn \l__sldelims_csname_tl { __slderivs_ }
    % \tl_show:N \l__sldelims_csname_tl
    \exp_args:Nc \DeclarePairedDelimiterX  \l__sldelims_csname_tl
      [1] {#2} {#3}
      { \__sldelims_opt:n { ##1 } }
    % \cs_show:c { \l__sldelims_csname_tl }
    \tl_set:Nn \l__sldelims_code_tl { \__sldelims_choose:cnnn }
    \__sldelims_tl_put_right_braced:NV \l__sldelims_code_tl \l__sldelims_csname_tl
    \tl_put_right:Nn \l__sldelims_code_tl { {##1} {##2} { {##3} } }
    % \tl_show:N \l__sldelims_code_tl
    \exp_args:NNnV
    \NewDocumentCommand #1 { s o m } \l__sldelims_code_tl
    % \cs_log:N #1
    % \cs_log:c { \cs_to_str:N #1 ~code }
  }
%--------------------------------------------------------------------------------
% Define delimiters with multiple argument and code for insertion
% #1: Command to define
% #2: Left delimiter
% #3: Right delimiter
% #4: Integer - Number of arguments
% #5: Code for insertion
\cs_new_protected:Nn \__sldelims_new:Nnnnn
  {
    \tl_set:Nx \l__sldelims_csname_tl { \cs_to_str:N #1 }
    % name of private fn to implement public one
    \tl_put_left:Nn \l__sldelims_csname_tl { __slderivs_ }
    % declare the private function
    \exp_args:Nc \DeclarePairedDelimiterX { \tl_use:N \l__sldelims_csname_tl }
      [#4] {#2} {#3} {#5}
    % build the argument specification for xparse
    \tl_set:Nn \l__sldelims_argspec_tl { s~o }
    % build the argument token list for \__sldelims_choose:Nnnn
    \tl_clear:N \l__sldelims_arguse_tl
    \int_step_inline:nn {#4}
      {
        \tl_put_right:Nn \l__sldelims_argspec_tl { ~m }
        \tl_put_right:Nx \l__sldelims_arguse_tl { ~{ ######## \int_eval:n{##1 + 2} } }
      }
    % build the code for the public function
    \tl_set:Nn \l__sldelims_code_tl { \__sldelims_choose:cnnn }
    \__sldelims_tl_put_right_braced:NV \l__sldelims_code_tl \l__sldelims_csname_tl
    \tl_put_right:Nn \l__sldelims_code_tl { {##1} {##2} }
    \__sldelims_tl_put_right_braced:NV \l__sldelims_code_tl \l__sldelims_arguse_tl
    % \tl_log:N \l__sldelims_argspec_tl
    % \tl_log:N \l__sldelims_arguse_tl
    % Define the public function
    \exp_args:NNVV
    \NewDocumentCommand #1 \l__sldelims_argspec_tl \l__sldelims_code_tl
  }
\cs_generate_variant:Nn \__sldelims_new:Nnnnn { c }
%--------------------------------------------------------------------------------
% % Define delimiters with one argument, simple insertion
% % #1: Command to define
% % #2: Left delimiter
% % #3: Right delimiter
% \cs_new_protected:Nn \__sldelims_new:Nnn
%   {
%     \__sldelims_new:Nnnnn #1 {#2} {#3} {1} { \__sldelims_opt:n {##1} }
%   }
%--------------------------------------------------------------------------------
% Define delimited fraction with two arguments, inserted in a \frac{}{}
% #1: Command to define
% #2: Left delimiter
% #3: Right delimiter
\cs_new_protected:Nn \__sldelims_frac:Nnn
  {
    \__sldelims_new:Nnnnn #1 {#2} {#3} {2} { \frac{##1}{##2} }
  }
%================================================================================
% brackets etc.
\__sldelims_new:Nnn \prn { \lparen } { \rparen }
\__sldelims_new:Nnn \brc { \lbrace } { \rbrace }
\__sldelims_new:Nnn \brk { \lbrack } { \rbrack }
\__sldelims_new:Nnn \abs { \lvert } { \rvert }
\__sldelims_new:Nnn \nrm { \lVert } { \rVert }
\__sldelims_new:Nnn \av { \langle } { \rangle }
\__sldelims_new:Nnn \ceil { \lceil } { \rceil }
\__sldelims_new:Nnn \floor { \lfloor } { \rfloor }
\__sldelims_new:Nnnnn \avc { \langle } { \rangle } {2}
  { \__sldelims_opt:n{#1} \delimsize \mvert \mathopen{} \__sldelims_opt:n{#2} }
%\newenvironment{cases}{\dleft\{\begin{aligned}}{\end{aligned}\dright.}
%
% Sets
\__sldelims_new:Nnnnn \set { \lbrace } { \rbrace } {2}
  { \__sldelims_opt:n{#1} \delimsize \mvert \mathopen{} \__sldelims_opt:n{#2} }
\__sldelims_new:Nnnnn \cond { \lparen } { \rparen } {2}
  { \__sldelims_opt:n{#1}  \delimsize \mvert \mathopen{} \__sldelims_opt:n{#2} }
\__sldelims_new:Nnnnn \condb { \lbrack } { \rbrack } {2}
  { \__sldelims_opt:n{#1}  \delimsize \mvert \mathopen{} \__sldelims_opt:n{#2} }
%
% QM Dirac notation
\__sldelims_new:Nnn \bra { \langle } { \rvert }
\__sldelims_new:Nnn \ket { \lvert } { \rangle }
\__sldelims_new:Nnnnn \braket { \langle } { \rangle } {2}
  { \__sldelims_opt:n{#1}  \delimsize \mvert \mathopen{} \__sldelims_opt:n{#2} }
\__sldelims_new:Nnnnn \brackets { \langle } { \rangle } {3}
  {
    \__sldelims_opt:n{#1} \delimsize \mvert \mathopen{}
    \__sldelims_opt:n{#2} \delimsize \mvert \mathopen{} \__sldelims_opt:n{#3}
  }
%
% Bracketed fractions
\__sldelims_frac:Nnn \prnfrac { \lparen } { \rparen }
\__sldelims_frac:Nnn \brcfrac { \lbrace } { \rbrace }
\__sldelims_frac:Nnn \brkfrac { \lbrack } { \rbrack }
\__sldelims_frac:Nnn \absfrac { \lvert } { \rvert }
\__sldelims_frac:Nnn \nrmfrac { \lVert } { \rVert }
\__sldelims_frac:Nnn \avfrac { \langle } { \rangle }
\__sldelims_frac:Nnn \ceilfrac { \lceil } { \rceil }
\__sldelims_frac:Nnn \floorfrac { \lfloor } { \rfloor }
%================================================================================
\ExplSyntaxOff
\endinput