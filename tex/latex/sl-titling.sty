%%  This uses the package ``titling'' to add affiliations for authors
%%
%% Requires packages: titling and etoolbox
%% If loaded BEFORE hyperref, cleveref: it's a good idea to use the options hyper, clever
%% If loaded AFTER hyperref, cleveref: \thanks and \email will produce warnings
%%
%% Add affiliations with
%%          \affiliation*{My University}
%% if you don't need numbers
%%
%% Or use
%%          \affiliation{My University\label{key}}
%% to number them
%% **** note that the label is inside the \affiliation command ****
%%
%% You can pair authors with affiliations like this:
%%          \author{Alice Smith\afref{key1} and Bob Jones\afref{key2}}
%%
%% Provides command \email{alice@smith.com}
%%   uses \thanks - appears as footnote, marker has zero width
%%   when using midline, put it before comma or follow with \thaksgap
%%   \thanksgap redefined to \hspace{\thanksgaplen}
%%   \thanksgaplen defined as width of ^*
%%
%% You can customise formatting:
%%  \preaffiliation{<commands to put at start of each affiliation>}
%%  \postaffiliation{<commands to put at end of each affiliation>>}
%%
%%  \renewcommand{\affilformat}[1]{<command for label{#1}>}
%%
%% defaults:
%%   \preaffiliation{\centering\it}
%%   \postaffiliation{\par}
%%   \newcommand{\affilformat}[1]{\textsuperscript{(#1)}}

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{sl-titling}
         [2016/07/27 v0.01beta titling macros for affiliations (SL)]



%\usepackage{etoolbox}

\RequirePackage{etoolbox}
\newtoggle{hyper}
%\newtoggle{clever}

\DeclareOption{nohyper}{\togglefalse{hyper}}
\DeclareOption{hyper}{\toggletrue{hyper}}
%\DeclareOption{noclever}{\togglefalse{clever}}
%\DeclareOption{clever}{\toggletrue{clever}}

\DeclareOption*{\PassOptionsToPackage{\CurrentOption}{titling}}

\ExecuteOptions{nohyper}
\ProcessOptions

\RequirePackage{titling}
%\input{pgfutil-common.tex}
\RequirePackage{pgffor}
\RequirePackage{xkeyval}
%\usepackage{titling}
%\usepackage{etoolbox}
%\usepackage{pgffor}
%\usepackage{xkeyval}

\makeatletter
\@ifpackageloaded{hyperref}{\toggletrue{hyper}}{}
%\@ifpackageloaded{cleveref}{\toggletrue{clever}}{}
\makeatother


\newcounter{affil}
\renewcommand{\theaffil}{\arabic{affil}}
%\iftoggle{clever}{\AtBeginDocument{%
% \crefname{affil}{affiliation}{affiliations}
% \crefformat{affil}{#2#1#3}
% \crefrangeformat{affil}{#3#1#4--#5#2#6}
% \crefmultiformat{affil}{#2#1#3}{,#2#1#3}{,#2#1#3}{,#2#1#3}
% \crefrangemultiformat{affil}{#2#1#3}{,#2#1#3}{,#2#1#3}{,#2#1#3}
% \labelcrefformat{affil}{#2#1#3}
% \labelcrefrangeformat{affil}{#3#1#4--#5#2#6}
% \labelcrefmultiformat{affil}{#2#1#3}{,#2#1#3}{,#2#1#3}{,#2#1#3}
% \labelcrefrangemultiformat{affil}{#2#1#3}{,#2#1#3}{,#2#1#3}{,#2#1#3}
%}}{}

\newcommand{\affilformat}[1]{\textsuperscript{#1}}
\newcommand*{\affilrefcmd}[1]{\ref{#1}}

%\newcommand{\afref}[1]{\affilformat{\affilrefcmd{#1}}}
%\newcommand*{\afref}[1]{\affilformat{\forcsvlist{\affilrefcmd}{#1}}}
\newcommand{\afref}[1]{\protect\affilformat{%
\foreach \x [count=\ix] in {#1}%
{\ifnumequal{\ix}{1}%
{\affilrefcmd{\x}}%then
{,\affilrefcmd{\x}}%else
}}}

\iftoggle{hyper}{%
% \iftoggle{clever}{%
%  \renewcommand{\affilrefcmd}[1]{\labelcref*{#1}}%
% }{%
  \renewcommand{\affilrefcmd}[1]{\ref*{#1}}%
% }
 \providecommand{\email}[1]{\thanks{\href{mailto:#1}{email: \texttt{#1}}}}%
}{%
% \iftoggle{clever}{%
%  \renewcommand{\affilrefcmd}[1]{\labelcref{#1}}%
% }{%
  \renewcommand{\affilrefcmd}[1]{\ref{#1}}%
% }
 \providecommand{\email}[1]{\thanks{email: \texttt{#1}}}%
}
\newlength{\thanksgaplen}
\renewcommand{\thanksgap}[1][\textsuperscript{*}]{%
\settowidth{\thanksgaplen}{#2}%
\hspace{\thanksgaplen}%
}

\makeatletter

\newcommand{\preaffiliation}[1]{\def\@bspreaffiliation{#1}}
\newcommand{\postaffiliation}[1]{\def\@bspostaffiliation{#1}}

\preaffiliation{\centering\itshape}
\postaffiliation{\par}

\def\affiliation{\@ifstar\@affiliationstar\@affiliation}
%
\def\@affiliationstar#1{\appto\maketitlehookc{\begingroup%
\@bspreaffiliation#1\@bspostaffiliation%
\endgroup}}
%
\def\@affiliation#1{\appto\maketitlehookc{\begingroup%
\refstepcounter{affil}\affilformat{\theaffil}%
\@bspreaffiliation#1\@bspostaffiliation%
\endgroup}}

\makeatother

\endinput
%%
%% End of file `sl-titling.sty'.
